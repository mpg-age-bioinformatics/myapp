#!/bin/bash

set -e

# Parse image name for repo name
tagStart=$(expr index "$IMAGE_NAME" :)
repoName=${IMAGE_NAME:0:tagStart-1}

echo ":: Additional tagging"
echo ":: Repo: ${repoName}"
echo ":: Image: ${IMAGE_NAME}"
echo ":: Tag: ${DOCKER_TAG}"


# Tag and push image for each additional tag
if [ "${DOCKER_TAG}" == "latest" ] ; 
    then
        if [ $(git describe --abbrev=0 --tags) ] ; 
            then 
                tag=$(git describe --abbrev=0 --tags)
                docker tag mpgagebioinformatics/myapp:${DOCKER_TAG} mpgagebioinformatics/myapp:${tag}-latest
                docker push mpgagebioinformatics/myapp:${tag}-latest
                echo ":: Added tag: ${tag}-latest"
        fi

elif [ "${DOCKER_TAG}" == "nightly" ] ;
    then
        if [ $(git describe --abbrev=0 --tags) ] ; 
            then 
                tag=$(git describe --abbrev=0 --tags)
                docker tag mpgagebioinformatics/myapp:${DOCKER_TAG} mpgagebioinformatics/myapp:${tag}-nightly
                docker push mpgagebioinformatics/myapp:${tag}-nightly
                echo ":: Added tag: ${tag}-nightly"
        fi
        docker tag mpgagebioinformatics/myapp:${DOCKER_TAG} mpgagebioinformatics/myapp:latest
        docker push mpgagebioinformatics/myapp:latest
        echo ":: Added tag: latest"

elif [ $(git describe --abbrev=0 --tags) ] ; 
        tag=$(git describe --abbrev=0 --tags)
        docker tag mpgagebioinformatics/myapp:${DOCKER_TAG} mpgagebioinformatics/myapp:latest
        docker push mpgagebioinformatics/myapp:latest
        echo ":: Added tag: latest"
fi